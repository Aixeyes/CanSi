CanSi 백엔드 기능 정의서 (초안)

1. 목적
계약서(PDF/이미지)를 입력받아 조항을 추출하고, 관련 판례/법령을 연결하여
사용자가 판단할 수 있는 근거 자료와 요약 리포트를 제공한다.

2. 범위
- 입력: 계약서 PDF/이미지 파일
- 출력: 조항 목록, 위험(의심) 조항, 관련 판례/법령, 요약 리포트, 토론 로그

3. 주요 기능
3.0 파이프라인 개요 (현재 구현 기준)
- 1) OCR -> 2) 텍스트 정제/조항 분리 -> 3) 위험 조항 필터링
- 4) 판례/법령 검색 -> 5) 임베딩 유사도 매칭 -> 6) 위험 유형 매핑
- 7) 협상/토론 생성 -> 8) 요약 리포트 생성 -> 9) 결과 저장(JSON)

3.1 OCR 텍스트 추출
- Upstage OCR로 계약서 이미지/PDF에서 텍스트 추출
- 실패 시 오류 반환

3.2 텍스트 정제 및 조항 분리
- 불필요한 공백/노이즈 제거
- 조항(제n조) 단위로 분리
- 분리 실패 시 fallback 로직 적용

3.3 위험 조항 선별
- 규칙 기반 + LLM 기반 위험 조항 필터링
- 위험 조항 목록 생성

3.4 판례 검색
- law.go.kr DRF 판례 API 연동
- 키워드 기반 판례 수집 및 상세 본문 보강
- 최소 결과 수 미달 시 보완 검색

3.5 법령/자치법규 검색
- law.go.kr DRF 법령/자치법규 API 연동
- 기본 질의어(주택임대차보호법) 우선 조회
- 도메인 키워드 필터링 및 중복 제거
 - 중앙법 우선 수집 후 필요 시 자치법규 확장

3.6 유사도 매칭
- OpenAI 임베딩 생성
- 조항 텍스트와 판례/법령 간 유사도 계산
- 조항별 관련 판례/법령 Top-K 매칭

3.7 위험 유형 매핑
- 위험 카테고리 키워드 매칭
- 조항별 위험 유형 분류

3.8 협상/토론 생성
- 계약 유형 감지
- 갑/을 관점 토론 로그 생성

3.9 요약 리포트 생성
- LLM 기반 종합 요약 리포트 생성

3.10 결과 저장
- 분석 결과를 JSON으로 저장 (analysis_result.json 등)
- API 응답 포맷으로 직렬화

4. 결과 데이터 구조 (요약)
- filename
- raw_text
- clauses
- risky_clauses
- precedents
- laws
- llm_summary
- debate_transcript
- contract_type

5. 환경변수
- UPSTAGE_API_KEY
- OPENAI_API_KEY
- PRECEDENT_API_URL / PRECEDENT_API_KEY
- LAW_API_URL / LAW_API_KEY / LAW_TARGETS
- LAW_DOMAIN_KEYWORDS / LAW_TITLE_MUST_KEYWORDS / LAW_BASE_QUERY

6. API
- POST /analyze/file
  - 입력: multipart/form-data (file)
  - 출력: 요약/조항/토론/관련 법령 포함 JSON

7. 제한 사항
- OCR 품질에 따라 조항 분리 정확도 변동
- 법령/판례 API 응답 품질에 의존
- 임베딩 API 키 미설정 시 유사도 매칭 불가

8. 비전공자용 사용 흐름 요약
1) 계약서(PDF/이미지)를 업로드합니다.
2) 시스템이 계약서의 글자를 읽고(자동 인식) 조항을 나눕니다.
3) 조항과 관련된 판례/법령을 자동으로 찾아 붙입니다.
4) 조항별 요약과 참고 자료를 확인하고, 최종 판단은 사용자가 합니다.
5) 결과는 JSON 파일로 저장하거나 화면에서 확인할 수 있습니다.
